<% content_for :title, "Your Projects â€¢ Reboot" %>
<% content_for :page, "projects" %>

<%= render "shared/navbar" %>

<main class="container">
  <h1 class="page-title">Your Projects</h1>
  <section class="grid">
    <aside class="projects-list">
      <% if @projects.any? %>
        <% @projects.each_with_index do |project, index| %>
          <a href="<%= projects_path(selected: project.id) %>" 
             class="project-row <%= index.odd? ? 'project-row--alt' : '' %> <%= project == @selected_project ? 'project-row--selected' : '' %>">
            <div class="project-row__title"><%= project.name %></div>
            <div class="pill pill--status"><%= project.status.humanize %></div>
            <div class="pill pill--time"><%= project.hours.to_i %>h</div>
          </a>
        <% end %>
        <button id="create-project-btn" class="btn btn--primary btn--block" style="margin-top: 8px;">+ New Project</button>
      <% else %>
        <div class="card" style="text-align: center; padding: 40px;">
          <p class="muted">No projects yet.</p>
          <button id="create-project-btn" class="btn btn--primary" style="margin-top: 16px;">Create your first project</button>
        </div>
      <% end %>
    </aside>

    <section class="project-detail card">
      <% if @selected_project %>
        <header class="project-detail__header">
          <h2 class="project-detail__title"><%= @selected_project.name %></h2>
          <div class="project-detail__actions">
            <% if @selected_project.status == 'pending' && !@selected_project.uses_hackatime? %>
              <button id="journal-btn" class="btn">Write Journal</button>
            <% elsif @selected_project.uses_hackatime? %>
              <button class="btn" disabled title="Hours tracked via Hackatime">Hackatime Linked</button>
            <% else %>
              <button class="btn" disabled>Write Journal</button>
            <% end %>
            <% if @selected_project.status.in?(%w[pending rejected]) %>
              <button id="edit-ship-btn" class="btn">Edit Ship</button>
            <% else %>
              <button class="btn" disabled>Edit Ship</button>
            <% end %>
          </div>
        </header>

        <div class="project-detail__content">
          <div class="detail-panel">
            <div class="detail-row">
              <div class="detail-label">Description</div>
              <div class="detail-value"><%= @selected_project.description.presence || "â€”" %></div>
            </div>

            <div class="detail-row">
              <div class="detail-label">Project Status</div>
              <div class="detail-value">
                <span class="dot <%= 'dot--filled' if @selected_project.status == 'pending' %>"></span>
                Pending
                <span class="spacer"></span>
                <span class="dot <%= 'dot--filled' if @selected_project.status == 'in-review' %>"></span>
                In Review
                <span class="spacer"></span>
                <span class="dot <%= 'dot--filled' if @selected_project.status == 'approved' %>"></span>
                Approved
              </div>
            </div>

            <div class="detail-group">
              <div class="detail-subtitle">Project Tracking</div>
              <div class="tracking-table">
                <div class="tracking-row tracking-row--head">
                  <div>Project</div>
                  <div>Raw</div>
                  <div>Approved</div>
                </div>
                <div class="tracking-row">
                  <div><%= @selected_project.name %></div>
                  <div><%= @selected_project.hours.to_i %>h</div>
                  <div><%= @selected_project.status == 'approved' ? "#{@selected_project.approved_hours.to_i}h" : "â€”" %></div>
                </div>
              </div>
            </div>

            <% if @selected_project.uses_hackatime? %>
              <div class="detail-group">
                <div class="detail-subtitle">Hours Source</div>
                <p class="muted">
                  <strong>Hackatime:</strong> <%= @selected_project.hackatime_project_name %>
                  <button type="button" id="sync-hackatime-btn" class="link-btn" style="margin-left: 8px;">Refresh Hours</button>
                </p>
              </div>
            <% elsif @selected_project.status == 'pending' %>
              <div class="detail-group">
                <div class="detail-subtitle">Journal Entries</div>
                <div id="journal-entries-list" class="journal-entries">
                  <p class="muted">No journal entries yet. <button type="button" id="quick-journal-btn" class="link-btn">Add one</button>.</p>
                </div>
              </div>
            <% end %>

            <div style="margin-top: 2rem;">
              <% if @selected_project.can_request_review? %>
                <% if @selected_project.ready_to_ship? %>
                  <%= form_with url: request_project_review_path(@selected_project), method: :post, local: true do %>
                    <button type="submit" class="btn btn--accent btn--block">
                      <%= @selected_project.status == 'rejected' ? 'Ship Again' : 'Ship It!' %>
                    </button>
                  <% end %>
                <% else %>
                  <button class="btn btn--accent btn--block" disabled title="Fill in all required fields first">
                    Ship It!
                  </button>
                  <p class="muted" style="font-size: 0.85rem; margin-top: 8px; text-align: center;">
                    Complete all fields to ship: description, code URL, playable URL, screenshot URL
                  </p>
                <% end %>
              <% else %>
                <button class="btn btn--accent btn--block" disabled>
                  <%= @selected_project.status == 'in-review' ? 'Shipped - Awaiting Review' : @selected_project.status.humanize %>
                </button>
              <% end %>
            </div>

            <div class="detail-group">
              <div class="detail-subtitle">Review Feedback</div>
              <% if @selected_project.status == 'approved' %>
                <div class="review-card">
                  <p><strong>ðŸŽ‰ Approved for <%= @selected_project.approved_hours %>h</strong></p>
                  <% if @selected_project.user_reason.present? %>
                    <p style="margin-top: 8px;"><%= @selected_project.user_reason %></p>
                  <% end %>
                  <p class="muted" style="font-size: 12px; margin-top: 8px;">
                    Reviewed <%= time_ago_in_words(@selected_project.reviewed_at) %> ago
                  </p>
                </div>
              <% elsif @selected_project.status == 'rejected' %>
                <div class="review-card review-card--rejected">
                  <p><strong>Rejected</strong></p>
                  <% if @selected_project.user_reason.present? %>
                    <p style="margin-top: 8px;"><%= @selected_project.user_reason %></p>
                  <% end %>
                  <p class="muted" style="font-size: 12px; margin-top: 8px;">
                    Reviewed <%= time_ago_in_words(@selected_project.reviewed_at) %> ago
                  </p>
                </div>
              <% else %>
                <p class="muted">No reviews yet.</p>
              <% end %>
            </div>
          </div>
        </div>
      <% else %>
        <header class="project-detail__header">
          <h2 class="project-detail__title">Select a project</h2>
        </header>
        <div class="project-detail__content">
          <div class="detail-panel">
            <p class="muted">Create a project to get started!</p>
          </div>
        </div>
      <% end %>
    </section>
  </section>
</main>

<div id="journal-modal" class="modal modal--hidden">
  <div class="modal__backdrop"></div>
  <div class="modal__content card">
    <header class="modal__header">
      <h2 class="modal__title">New Journal Entry</h2>
      <button type="button" class="modal__close" aria-label="Close">&times;</button>
    </header>
    <form class="form" id="journal-form">
      <div class="form-group">
        <label class="form__label" for="journal_date">Date *</label>
        <input class="form__input" type="date" id="journal_date" required>
      </div>
      
      <div class="form-group">
        <label class="form__label" for="journal_hours">Hours Worked *</label>
        <input class="form__input" type="number" id="journal_hours" min="0" step="0.5" required>
      </div>
      
      <div class="form-group">
        <label class="form__label" for="journal_content">What did you work on? * <span style="font-size: 0.85rem; color: #999;">(markdown supported)</span></label>
        <textarea class="form__input form__textarea" id="journal_content" rows="4" placeholder="Describe your progress... (markdown supported)" required></textarea>
      </div>
      
      <div class="form-group">
        <label class="form__label" for="journal_tools">Tools/Languages Used</label>
        <input class="form__input" type="text" id="journal_tools" placeholder="e.g. React, Python, HTML/CSS">
      </div>
      
      <div style="display: flex; gap: 0.5rem;">
        <button type="button" class="btn btn--ghost modal__close-btn">Cancel</button>
        <button type="button" class="btn btn--primary" id="journal-submit-btn">Save Journal Entry</button>
      </div>
    </form>
  </div>
</div>

<div id="create-project-modal" class="modal modal--hidden">
  <div class="modal__backdrop"></div>
  <div class="modal__content card">
    <header class="modal__header">
      <h2 class="modal__title">New Project</h2>
      <button type="button" class="modal__close" aria-label="Close">&times;</button>
    </header>
    <%= form_with url: create_project_path, method: :post, local: true, class: "form" do |f| %>
      <label class="form__label" for="project_name">Project Name *</label>
      <input class="form__input" type="text" id="project_name" name="project[name]" required>

      <label class="form__label" for="project_description">Description</label>
      <textarea class="form__input form__textarea" id="project_description" name="project[description]" rows="3"></textarea>

      <label class="form__label" for="project_code_url">Code URL</label>
      <input class="form__input" type="url" id="project_code_url" name="project[code_url]" placeholder="https://github.com/...">

      <label class="form__label" for="project_playable_url">Playable URL</label>
      <input class="form__input" type="url" id="project_playable_url" name="project[playable_url]" placeholder="https://...">

      <label class="form__label" for="project_hackatime">Link Hackatime Project (optional)</label>
      <select class="form__input" id="project_hackatime" name="project[hackatime_project_name]">
        <option value="">Manual journaling (no Hackatime)</option>
      </select>
      <p class="muted" style="font-size: 0.8rem; margin-top: 4px;">If linked, hours are pulled from Hackatime and journal is disabled.</p>

      <button type="submit" class="btn btn--primary btn--block">Create Project</button>
    <% end %>
  </div>
</div>

<% if @selected_project&.status&.in?(%w[pending rejected]) %>
<div id="edit-ship-modal" class="modal modal--hidden">
  <div class="modal__backdrop"></div>
  <div class="modal__content card">
    <header class="modal__header">
      <h2 class="modal__title">Edit Project</h2>
      <button type="button" class="modal__close" aria-label="Close">&times;</button>
    </header>
    <form class="form" id="edit-ship-form">
      <div class="form-group">
        <label class="form__label" for="edit_project_name">Project Name *</label>
        <input class="form__input" type="text" id="edit_project_name" value="<%= @selected_project.name %>" required>
      </div>

      <div class="form-group">
        <label class="form__label" for="edit_project_description">Description</label>
        <textarea class="form__input form__textarea" id="edit_project_description" rows="3"><%= @selected_project.description %></textarea>
      </div>

      <div class="form-group">
        <label class="form__label" for="edit_project_code_url">Code URL</label>
        <input class="form__input" type="url" id="edit_project_code_url" value="<%= @selected_project.code_url %>" placeholder="https://github.com/...">
      </div>

      <div class="form-group">
        <label class="form__label" for="edit_project_playable_url">Playable URL</label>
        <input class="form__input" type="url" id="edit_project_playable_url" value="<%= @selected_project.playable_url %>" placeholder="https://...">
      </div>

      <div class="form-group">
        <label class="form__label" for="edit_project_screenshot_url">Screenshot URL</label>
        <input class="form__input" type="url" id="edit_project_screenshot_url" value="<%= @selected_project.screenshot_url %>" placeholder="https://...">
      </div>

      <div class="form-group">
        <label class="form__label" for="edit_project_hackatime">Link Hackatime Project</label>
        <select class="form__input" id="edit_project_hackatime">
          <option value="">Manual journaling (no Hackatime)</option>
          <% if @selected_project.hackatime_project_name.present? %>
            <option value="<%= @selected_project.hackatime_project_name %>" selected><%= @selected_project.hackatime_project_name %> (current)</option>
          <% end %>
        </select>
        <p class="muted" style="font-size: 0.8rem; margin-top: 4px;">If linked, hours are pulled from Hackatime and journal is disabled.</p>
      </div>

      <div style="display: flex; gap: 0.5rem;">
        <button type="button" class="btn btn--ghost modal__close-btn">Cancel</button>
        <button type="submit" class="btn btn--primary" id="edit-ship-submit-btn">Save Changes</button>
      </div>
    </form>
  </div>
</div>
<% end %>

<style>
  .link-btn {
    background: none;
    border: none;
    color: #8b5cf6;
    cursor: pointer;
    text-decoration: underline;
    padding: 0;
    font: inherit;
    font-size: inherit;
  }

  .link-btn:hover {
    opacity: 0.7;
  }

  .journal-entries {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .journal-entry {
    padding: 1rem;
    transition: background-color 0.2s ease;
    border: 1px solid #f0f0f0;
  }

  .journal-entry:hover {
    background-color: #fafafa;
  }

  .journal-entry__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .journal-entry__date {
    color: #1f2430;
    font-size: 0.95rem;
  }

  .journal-entry__hours {
    background: #f0f0f0;
    color: #666;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.85rem;
  }

  .journal-entry__content {
    color: #666;
    margin: 0.5rem 0 0 0;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .journal-entry__tools {
    margin: 0.5rem 0 0 0 !important;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    color: #1f2430;
  }

  .form-group input,
  .form-group textarea {
    width: 100% !important;
  }
</style>

<script>
  const PROJECT_ID = <%= @selected_project&.id || 'null' %>;
  
  // Journal Modal handlers
  const journalBtn = document.getElementById('journal-btn');
  const quickJournalBtn = document.getElementById('quick-journal-btn');
  const journalModal = document.getElementById('journal-modal');
  const journalForm = document.getElementById('journal-form');
  const journalSubmitBtn = document.getElementById('journal-submit-btn');
  const journalEntriesList = document.getElementById('journal-entries-list');
  
  function openJournalModal() {
    journalModal?.classList.remove('modal--hidden');
    document.getElementById('journal_date').valueAsDate = new Date();
  }
  
  function closeJournalModal() {
    journalModal?.classList.add('modal--hidden');
  }
  
  journalBtn?.addEventListener('click', openJournalModal);
  quickJournalBtn?.addEventListener('click', openJournalModal);
  
  journalModal?.querySelectorAll('.modal__close, .modal__close-btn').forEach(btn => {
    btn.addEventListener('click', closeJournalModal);
  });
  
  journalModal?.querySelector('.modal__backdrop')?.addEventListener('click', closeJournalModal);

  // Renders a single journal entry as HTML.
  function renderJournalEntry(entry) {
    const date = new Date(entry.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    const toolsHtml = entry.tools ? `<p class="journal-entry__tools muted"><strong>Tools:</strong> ${escapeHtml(entry.tools)}</p>` : '';
    return `
      <div class="journal-entry" data-id="${entry.id}">
        <div class="journal-entry__header">
          <span class="journal-entry__date">${date}</span>
          <span class="journal-entry__hours">${entry.hours}h</span>
        </div>
        <p class="journal-entry__content">${escapeHtml(entry.content)}</p>
        ${toolsHtml}
      </div>
    `;
  }

  // Escapes HTML to prevent XSS.
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Loads journal entries from the API and renders them.
  async function loadJournalEntries() {
    if (!PROJECT_ID || !journalEntriesList) return;
    
    try {
      const response = await fetch(`/api/v1/projects/${PROJECT_ID}/journal_entries`, {
        headers: { 'Accept': 'application/json' },
        credentials: 'same-origin'
      });
      
      if (!response.ok) return;
      
      const data = await response.json();
      const entries = data.journal_entries || [];
      
      if (entries.length === 0) {
        journalEntriesList.innerHTML = '<p class="muted">No journal entries yet. <button type="button" id="quick-journal-btn" class="link-btn">Add one</button>.</p>';
        document.getElementById('quick-journal-btn')?.addEventListener('click', openJournalModal);
      } else {
        journalEntriesList.innerHTML = entries.map(renderJournalEntry).join('');
      }
    } catch (error) {
      console.error('Failed to load journal entries:', error);
    }
  }

  // Submits a new journal entry to the API.
  journalSubmitBtn?.addEventListener('click', async (e) => {
    e.preventDefault();
    
    const date = document.getElementById('journal_date').value;
    const hours = document.getElementById('journal_hours').value;
    const content = document.getElementById('journal_content').value;
    const tools = document.getElementById('journal_tools').value;
    
    if (!date || !hours || !content) {
      alert('Please fill in all required fields.');
      return;
    }
    
    journalSubmitBtn.disabled = true;
    journalSubmitBtn.textContent = 'Saving...';
    
    try {
      const response = await fetch(`/api/v1/projects/${PROJECT_ID}/journal_entries`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
        },
        credentials: 'same-origin',
        body: JSON.stringify({
          journal_entry: { date, hours: parseFloat(hours), content, tools }
        })
      });
      
      if (response.ok) {
        journalForm?.reset();
        closeJournalModal();
        loadJournalEntries();
        window.location.reload();
      } else {
        const data = await response.json();
        alert(data.errors?.join(', ') || 'Failed to save journal entry.');
      }
    } catch (error) {
      console.error('Failed to save journal entry:', error);
      alert('Failed to save journal entry. Please try again.');
    } finally {
      journalSubmitBtn.disabled = false;
      journalSubmitBtn.textContent = 'Save Journal Entry';
    }
  });

  // Load entries on page load.
  document.addEventListener('DOMContentLoaded', loadJournalEntries);

  // Hackatime dropdown population
  const hackatimeSelect = document.getElementById('project_hackatime');
  
  async function loadHackatimeProjects() {
    if (!hackatimeSelect) return;
    
    try {
      const response = await fetch('/api/v1/hackatime/projects', {
        headers: { 'Accept': 'application/json' },
        credentials: 'same-origin'
      });
      
      if (!response.ok) return;
      
      const data = await response.json();
      const projects = data.projects || [];
      
      if (projects.length === 0 && data.error) {
        const opt = document.createElement('option');
        opt.disabled = true;
        opt.textContent = data.error;
        hackatimeSelect.appendChild(opt);
        return;
      }
      
      projects.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = `${p.name} (${p.hours}h)`;
        hackatimeSelect.appendChild(opt);
      });
    } catch (error) {
      console.error('Failed to load Hackatime projects:', error);
    }
  }

  // Sync Hackatime hours button
  const syncHackatimeBtn = document.getElementById('sync-hackatime-btn');
  
  syncHackatimeBtn?.addEventListener('click', async () => {
    syncHackatimeBtn.disabled = true;
    syncHackatimeBtn.textContent = 'Syncing...';
    
    try {
      const response = await fetch(`/api/v1/projects/${PROJECT_ID}/sync_hackatime`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
        },
        credentials: 'same-origin'
      });
      
      if (response.ok) {
        window.location.reload();
      } else {
        alert('Failed to sync hours from Hackatime.');
      }
    } catch (error) {
      console.error('Failed to sync Hackatime:', error);
      alert('Failed to sync hours from Hackatime.');
    } finally {
      syncHackatimeBtn.disabled = false;
      syncHackatimeBtn.textContent = 'Refresh Hours';
    }
  });

  // Load Hackatime projects when create modal opens
  const createProjectBtn = document.getElementById('create-project-btn');
  const createProjectModal = document.getElementById('create-project-modal');
  
  createProjectBtn?.addEventListener('click', () => {
    createProjectModal?.classList.remove('modal--hidden');
    loadHackatimeProjects();
  });
  
  createProjectModal?.querySelectorAll('.modal__close').forEach(btn => {
    btn.addEventListener('click', () => createProjectModal?.classList.add('modal--hidden'));
  });
  
  createProjectModal?.querySelector('.modal__backdrop')?.addEventListener('click', () => {
    createProjectModal?.classList.add('modal--hidden');
  });

  // Edit Ship Modal
  const editShipBtn = document.getElementById('edit-ship-btn');
  const editShipModal = document.getElementById('edit-ship-modal');
  const editShipForm = document.getElementById('edit-ship-form');

  editShipBtn?.addEventListener('click', () => {
    editShipModal?.classList.remove('modal--hidden');
    loadEditHackatimeProjects();
  });

  // Loads Hackatime projects into the edit modal dropdown.
  async function loadEditHackatimeProjects() {
    const select = document.getElementById('edit_project_hackatime');
    if (!select) return;
    
    // Avoid reloading if already populated
    if (select.options.length > 2) return;
    
    try {
      const response = await fetch('/api/v1/hackatime/projects', {
        headers: { 'Accept': 'application/json' },
        credentials: 'same-origin'
      });
      
      if (!response.ok) return;
      
      const data = await response.json();
      const projects = data.projects || [];
      
      projects.forEach(p => {
        // Skip if already the current selection
        if (select.querySelector(`option[value="${p.name}"]`)) return;
        
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = `${p.name} (${p.hours}h)`;
        select.appendChild(opt);
      });
    } catch (error) {
      console.error('Failed to load Hackatime projects:', error);
    }
  }

  editShipModal?.querySelectorAll('.modal__close, .modal__close-btn').forEach(btn => {
    btn.addEventListener('click', () => editShipModal?.classList.add('modal--hidden'));
  });

  editShipModal?.querySelector('.modal__backdrop')?.addEventListener('click', () => {
    editShipModal?.classList.add('modal--hidden');
  });

  editShipForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('edit-ship-submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';

    const data = {
      project: {
        name: document.getElementById('edit_project_name').value,
        description: document.getElementById('edit_project_description').value,
        code_url: document.getElementById('edit_project_code_url').value,
        playable_url: document.getElementById('edit_project_playable_url').value,
        screenshot_url: document.getElementById('edit_project_screenshot_url').value,
        hackatime_project_name: document.getElementById('edit_project_hackatime')?.value || ''
      }
    };

    try {
      const response = await fetch(`/api/v1/projects/${PROJECT_ID}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
        },
        credentials: 'same-origin',
        body: JSON.stringify(data)
      });

      if (response.ok) {
        window.location.reload();
      } else {
        const result = await response.json();
        alert(result.errors?.join(', ') || 'Failed to update project.');
      }
    } catch (error) {
      console.error('Failed to update project:', error);
      alert('Failed to update project. Please try again.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save Changes';
    }
  });
</script>
