<% content_for :title, "Your Projects • Reboot" %>
<% content_for :page, "projects" %>

<%= render "shared/navbar" %>

<main class="container">
  <h1 class="page-title">Your Projects</h1>
  <section class="grid">
    <aside class="projects-list">
      <% if @projects.any? %>
        <% @projects.each_with_index do |project, index| %>
          <a href="<%= projects_path(selected: project.id) %>" 
             class="project-row <%= index.odd? ? 'project-row--alt' : '' %> <%= project == @selected_project ? 'project-row--selected' : '' %>">
            <div class="project-row__title"><%= project.name %></div>
            <div class="pill pill--status"><%= project.status.humanize %></div>
            <div class="pill pill--time"><%= project.hours.to_i %>h</div>
          </a>
        <% end %>
        <button id="create-project-btn" class="btn btn--primary btn--block" style="margin-top: 8px;">+ New Project</button>
      <% else %>
        <div class="card" style="text-align: center; padding: 40px;">
          <p class="muted">No projects yet.</p>
          <button id="create-project-btn" class="btn btn--primary" style="margin-top: 16px;">Create your first project</button>
        </div>
      <% end %>
    </aside>

    <section class="project-detail card">
      <% if @selected_project %>
        <header class="project-detail__header">
          <h2 class="project-detail__title"><%= @selected_project.name %></h2>
          <div class="project-detail__actions">
            <% if @selected_project.status == 'pending' %>
              <button id="journal-btn" class="btn">Write Journal</button>
            <% else %>
              <button class="btn" disabled>Write Journal</button>
            <% end %>
            <button class="btn" disabled>Edit Ship</button>
          </div>
        </header>

        <div class="project-detail__content">
          <div class="detail-panel">
            <div class="detail-row">
              <div class="detail-label">Description</div>
              <div class="detail-value"><%= @selected_project.description.presence || "—" %></div>
            </div>

            <div class="detail-row">
              <div class="detail-label">Project Status</div>
              <div class="detail-value">
                <span class="dot <%= 'dot--filled' if @selected_project.status == 'pending' %>"></span>
                Pending
                <span class="spacer"></span>
                <span class="dot <%= 'dot--filled' if @selected_project.status == 'in-review' %>"></span>
                In Review
                <span class="spacer"></span>
                <span class="dot <%= 'dot--filled' if @selected_project.status == 'approved' %>"></span>
                Approved
              </div>
            </div>

            <div class="detail-group">
              <div class="detail-subtitle">Project Tracking</div>
              <div class="tracking-table">
                <div class="tracking-row tracking-row--head">
                  <div>Project</div>
                  <div>Raw</div>
                  <div>Approved</div>
                </div>
                <div class="tracking-row">
                  <div><%= @selected_project.name %></div>
                  <div><%= @selected_project.hours.to_i %>h</div>
                  <div><%= @selected_project.status == 'approved' ? "#{@selected_project.approved_hours.to_i}h" : "—" %></div>
                </div>
              </div>
            </div>

            <% if @selected_project.status == 'pending' %>
              <div class="detail-group">
                <div class="detail-subtitle">Journal Entries</div>
                <div id="journal-entries-list" class="journal-entries">
                  <p class="muted">No journal entries yet. <button type="button" id="quick-journal-btn" class="link-btn">Add one</button>.</p>
                </div>
              </div>
            <% end %>

            <div style="margin-top: 2rem;">
              <% if @selected_project.can_request_review? %>
                <%= form_with url: request_project_review_path(@selected_project), method: :post, local: true do %>
                  <button type="submit" class="btn btn--accent btn--block">
                    <%= @selected_project.status == 'rejected' ? 'Request review again' : 'Request review' %>
                  </button>
                <% end %>
              <% else %>
                <button class="btn btn--accent btn--block" disabled>
                  <%= @selected_project.status == 'in-review' ? 'In Review' : @selected_project.status.humanize %>
                </button>
              <% end %>
            </div>

            <div class="detail-group">
              <div class="detail-subtitle">Project Reviews</div>
              <% if @selected_project.approval_reason.present? %>
                <div class="review-card">
                  <p><strong>Approved for <%= @selected_project.approved_hours %>h</strong></p>
                  <p class="muted"><%= @selected_project.approval_reason %></p>
                  <p class="muted" style="font-size: 12px; margin-top: 8px;">
                    Reviewed <%= time_ago_in_words(@selected_project.reviewed_at) %> ago
                  </p>
                </div>
              <% elsif @selected_project.status == 'rejected' %>
                <div class="review-card review-card--rejected">
                  <p><strong>Rejected</strong></p>
                  <p class="muted" style="font-size: 12px;">
                    Reviewed <%= time_ago_in_words(@selected_project.reviewed_at) %> ago
                  </p>
                </div>
              <% else %>
                <p class="muted">No reviews yet.</p>
              <% end %>
            </div>
          </div>
        </div>
      <% else %>
        <header class="project-detail__header">
          <h2 class="project-detail__title">Select a project</h2>
        </header>
        <div class="project-detail__content">
          <div class="detail-panel">
            <p class="muted">Create a project to get started!</p>
          </div>
        </div>
      <% end %>
    </section>
  </section>
</main>

<div id="journal-modal" class="modal modal--hidden">
  <div class="modal__backdrop"></div>
  <div class="modal__content card">
    <header class="modal__header">
      <h2 class="modal__title">New Journal Entry</h2>
      <button type="button" class="modal__close" aria-label="Close">&times;</button>
    </header>
    <form class="form" id="journal-form">
      <div class="form-group">
        <label class="form__label" for="journal_date">Date *</label>
        <input class="form__input" type="date" id="journal_date" required>
      </div>
      
      <div class="form-group">
        <label class="form__label" for="journal_hours">Hours Worked *</label>
        <input class="form__input" type="number" id="journal_hours" min="0" step="0.5" required>
      </div>
      
      <div class="form-group">
        <label class="form__label" for="journal_content">What did you work on? * <span style="font-size: 0.85rem; color: #999;">(markdown supported)</span></label>
        <textarea class="form__input form__textarea" id="journal_content" rows="4" placeholder="Describe your progress... (markdown supported)" required></textarea>
      </div>
      
      <div class="form-group">
        <label class="form__label" for="journal_tools">Tools/Languages Used</label>
        <input class="form__input" type="text" id="journal_tools" placeholder="e.g. React, Python, HTML/CSS">
      </div>
      
      <div style="display: flex; gap: 0.5rem;">
        <button type="button" class="btn btn--ghost modal__close-btn">Cancel</button>
        <button type="button" class="btn btn--primary" id="journal-submit-btn">Save Journal Entry</button>
      </div>
    </form>
  </div>
</div>

<div id="create-project-modal" class="modal modal--hidden">
  <div class="modal__backdrop"></div>
  <div class="modal__content card">
    <header class="modal__header">
      <h2 class="modal__title">New Project</h2>
      <button type="button" class="modal__close" aria-label="Close">&times;</button>
    </header>
    <%= form_with url: create_project_path, method: :post, local: true, class: "form" do |f| %>
      <label class="form__label" for="project_name">Project Name *</label>
      <input class="form__input" type="text" id="project_name" name="project[name]" required>

      <label class="form__label" for="project_description">Description</label>
      <textarea class="form__input form__textarea" id="project_description" name="project[description]" rows="3"></textarea>

      <label class="form__label" for="project_code_url">Code URL</label>
      <input class="form__input" type="url" id="project_code_url" name="project[code_url]" placeholder="https://github.com/...">

      <label class="form__label" for="project_playable_url">Playable URL</label>
      <input class="form__input" type="url" id="project_playable_url" name="project[playable_url]" placeholder="https://...">

      <label class="form__label" for="project_hours">Estimated Hours</label>
      <input class="form__input" type="number" id="project_hours" name="project[hours]" min="0" step="0.5" value="0">

      <button type="submit" class="btn btn--primary btn--block">Create Project</button>
    <% end %>
  </div>
</div>

<style>
  .link-btn {
    background: none;
    border: none;
    color: #8b5cf6;
    cursor: pointer;
    text-decoration: underline;
    padding: 0;
    font: inherit;
    font-size: inherit;
  }

  .link-btn:hover {
    opacity: 0.7;
  }

  .journal-entries {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .journal-entry {
    padding: 1rem;
    transition: background-color 0.2s ease;
    border: 1px solid #f0f0f0;
  }

  .journal-entry:hover {
    background-color: #fafafa;
  }

  .journal-entry__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .journal-entry__date {
    color: #1f2430;
    font-size: 0.95rem;
  }

  .journal-entry__hours {
    background: #f0f0f0;
    color: #666;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.85rem;
  }

  .journal-entry__content {
    color: #666;
    margin: 0.5rem 0 0 0;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .journal-entry__tools {
    margin: 0.5rem 0 0 0 !important;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    color: #1f2430;
  }

  .form-group input,
  .form-group textarea {
    width: 100% !important;
  }
</style>

<script>
  // Journal Modal handlers
  const journalBtn = document.getElementById('journal-btn');
  const quickJournalBtn = document.getElementById('quick-journal-btn');
  const journalModal = document.getElementById('journal-modal');
  const journalForm = document.getElementById('journal-form');
  const journalSubmitBtn = document.getElementById('journal-submit-btn');
  
  function openJournalModal() {
    journalModal?.classList.remove('modal--hidden');
    document.getElementById('journal_date').valueAsDate = new Date();
  }
  
  function closeJournalModal() {
    journalModal?.classList.add('modal--hidden');
  }
  
  journalBtn?.addEventListener('click', openJournalModal);
  quickJournalBtn?.addEventListener('click', openJournalModal);
  
  journalModal?.querySelectorAll('.modal__close, .modal__close-btn').forEach(btn => {
    btn.addEventListener('click', closeJournalModal);
  });
  
  journalModal?.querySelector('.modal__backdrop')?.addEventListener('click', closeJournalModal);
  
  journalSubmitBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    const date = document.getElementById('journal_date').value;
    const hours = document.getElementById('journal_hours').value;
    const content = document.getElementById('journal_content').value;
    
    if (date && hours && content) {
      alert('DEV - Journal entry saved!');
      journalForm?.reset();
      closeJournalModal();
    }
  });
</script>
