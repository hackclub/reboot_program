<% content_for :title, "Admin • #{@project.name}" %>
<% content_for :page, "admin" %>

<header class="topbar">
  <nav class="nav">
    <a class="nav__item" href="/admin/projects">← Back to Projects</a>
    <a class="nav__item nav__item--active" href="/admin">Admin</a>
  </nav>
  <div class="topbar__right">
    <span class="muted">Admin: <%= @current_user.slack_username || @current_user.email %></span>
  </div>
</header>

<main class="container" style="max-width: 900px;">
  <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 1rem;">
    <a href="/admin/projects" style="padding: 8px 16px; border-bottom: 2px solid #f25f2c; color: #f25f2c; text-decoration: none; font-weight: 600;">Projects</a>
    <a href="/admin/users" style="padding: 8px 16px; border-bottom: 2px solid transparent; color: #999; text-decoration: none; font-weight: 600;">Users</a>
    <a href="/admin/shop" style="padding: 8px 16px; border-bottom: 2px solid transparent; color: #999; text-decoration: none; font-weight: 600;">Shop</a>
  </div>

  <div class="card" style="padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
      <div>
        <h1 style="margin: 0 0 0.5rem 0;"><%= @project.name %></h1>
        <p class="muted" style="margin: 0;">
          by <strong><%= @project.user.slack_username || @project.user.email %></strong>
          • Created <%= time_ago_in_words(@project.created_at) %> ago
        </p>
      </div>
      <span class="pill pill--<%= @project.status %>" style="font-size: 1rem; padding: 6px 12px;"><%= @project.status.humanize %></span>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
      <div>
        <h3 style="margin: 0 0 1rem 0; color: #666;">Project Details</h3>
        
        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-weight: 600; margin-bottom: 4px; color: #999; font-size: 0.85rem;">Description</label>
          <p style="margin: 0;"><%= @project.description.presence || "—" %></p>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-weight: 600; margin-bottom: 4px; color: #999; font-size: 0.85rem;">Code URL</label>
          <% if @project.code_url.present? %>
            <a href="<%= @project.code_url %>" target="_blank"><%= @project.code_url %></a>
          <% else %>
            <span class="muted">—</span>
          <% end %>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-weight: 600; margin-bottom: 4px; color: #999; font-size: 0.85rem;">Playable URL</label>
          <% if @project.playable_url.present? %>
            <a href="<%= @project.playable_url %>" target="_blank"><%= @project.playable_url %></a>
          <% else %>
            <span class="muted">—</span>
          <% end %>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-weight: 600; margin-bottom: 4px; color: #999; font-size: 0.85rem;">Screenshot</label>
          <% if @project.screenshot_url.present? %>
            <a href="<%= @project.screenshot_url %>" target="_blank">View Screenshot</a>
          <% else %>
            <span class="muted">—</span>
          <% end %>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="display: block; font-weight: 600; margin-bottom: 4px; color: #999; font-size: 0.85rem;">Hours Source</label>
          <% if @project.uses_hackatime? %>
            <span>Hackatime: <strong><%= @project.hackatime_project_name %></strong></span>
          <% else %>
            <span>Manual Journal</span>
          <% end %>
        </div>
      </div>

      <div>
        <h3 style="margin: 0 0 1rem 0; color: #666;">Hours & Review</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
          <div class="card" style="text-align: center; padding: 1rem;">
            <div style="font-size: 2rem; font-weight: 700;"><%= @project.hours.to_f.round(2) %></div>
            <div class="muted">Raw Hours</div>
          </div>
          <div class="card" style="text-align: center; padding: 1rem;">
            <div style="font-size: 2rem; font-weight: 700;"><%= @project.approved_hours.to_f.round(2) %></div>
            <div class="muted">Approved Hours</div>
          </div>
        </div>

        <% if @project.status == "in-review" %>
          <div style="background: #fff8e6; border: 1px solid #ffc107; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
            <strong style="color: #856404;">Awaiting Review</strong>
            <p class="muted" style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
              Submitted <%= time_ago_in_words(@project.submitted_at) %> ago
            </p>
          </div>

          <form id="approve-form" style="margin-bottom: 1rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 4px;">Approved Hours</label>
            <input type="number" id="approve_hours" value="<%= @project.hours.to_f.round(2) %>" min="0" step="0.5" 
                   style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 0.5rem;">
            
            <label style="display: block; font-weight: 600; margin-bottom: 4px;">Reason</label>
            <textarea id="approve_reason" rows="2" placeholder="Justification for approved hours..."
                      style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 0.5rem;"></textarea>
            
            <div style="display: flex; gap: 0.5rem;">
              <button type="button" id="approve-btn" class="btn btn--primary" style="flex: 1;">Approve</button>
              <button type="button" id="reject-btn" class="btn btn--ghost" style="flex: 1; color: #dc3545; border-color: #dc3545;">Reject</button>
            </div>
          </form>
        <% elsif @project.approval_reason.present? %>
          <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem;">
            <strong>Review Notes</strong>
            <p style="margin: 0.5rem 0 0 0;"><%= @project.approval_reason %></p>
            <p class="muted" style="margin: 0.5rem 0 0 0; font-size: 0.85rem;">
              Reviewed <%= time_ago_in_words(@project.reviewed_at) %> ago
            </p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <% if @project.journal_entries.any? %>
    <h2 style="margin: 2rem 0 1rem;">Journal Entries (<%= @project.journal_entries.count %>)</h2>
    <div class="card" style="padding: 0;">
      <% @project.journal_entries.order(date: :desc).each do |entry| %>
        <div style="padding: 1rem; border-bottom: 1px solid #f0f0f0;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <strong><%= entry.date.strftime("%b %d, %Y") %></strong>
            <span class="muted"><%= entry.hours %>h</span>
          </div>
          <p style="margin: 0;"><%= entry.content %></p>
          <% if entry.tools.present? %>
            <p class="muted" style="margin: 0.5rem 0 0 0; font-size: 0.85rem;"><strong>Tools:</strong> <%= entry.tools %></p>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</main>

<script>
  const projectId = <%= @project.id %>;
  const approveBtn = document.getElementById('approve-btn');
  const rejectBtn = document.getElementById('reject-btn');

  approveBtn?.addEventListener('click', async () => {
    const hours = parseFloat(document.getElementById('approve_hours').value);
    const reason = document.getElementById('approve_reason').value;

    if (!reason.trim()) {
      alert('Please provide a reason for approval.');
      return;
    }

    approveBtn.disabled = true;
    approveBtn.textContent = 'Approving...';

    try {
      const response = await fetch(`/api/v1/admin/projects/${projectId}/approve`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
        },
        credentials: 'same-origin',
        body: JSON.stringify({ hours, reason })
      });

      if (response.ok) {
        window.location.reload();
      } else {
        const data = await response.json();
        alert(data.error || 'Failed to approve project.');
      }
    } catch (error) {
      console.error('Failed to approve:', error);
      alert('Failed to approve project.');
    } finally {
      approveBtn.disabled = false;
      approveBtn.textContent = 'Approve';
    }
  });

  rejectBtn?.addEventListener('click', async () => {
    if (!confirm('Are you sure you want to reject this project?')) return;

    rejectBtn.disabled = true;
    rejectBtn.textContent = 'Rejecting...';

    try {
      const response = await fetch(`/api/v1/admin/projects/${projectId}/reject`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
        },
        credentials: 'same-origin'
      });

      if (response.ok) {
        window.location.reload();
      } else {
        const data = await response.json();
        alert(data.error || 'Failed to reject project.');
      }
    } catch (error) {
      console.error('Failed to reject:', error);
      alert('Failed to reject project.');
    } finally {
      rejectBtn.disabled = false;
      rejectBtn.textContent = 'Reject';
    }
  });
</script>
