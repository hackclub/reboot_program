<% content_for :title, "Admin • Projects" %>
<% content_for :page, "admin" %>

<header class="topbar">
  <nav class="nav">
    <a class="nav__item" href="/projects">← Back to Projects</a>
    <a class="nav__item nav__item--active" href="/admin/projects">Admin</a>
  </nav>
  <div class="topbar__right">
    <span class="muted">Admin: <%= @current_user.slack_username || @current_user.email %></span>
  </div>
</header>

<main class="container">
  <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 1rem;">
    <a href="/admin/projects" style="padding: 8px 16px; border-bottom: 2px solid #f25f2c; color: #f25f2c; text-decoration: none; font-weight: 600;">Projects</a>
    <a href="/admin/users" style="padding: 8px 16px; border-bottom: 2px solid transparent; color: #999; text-decoration: none; font-weight: 600;">Users</a>
    <a href="/admin/shop" style="padding: 8px 16px; border-bottom: 2px solid transparent; color: #999; text-decoration: none; font-weight: 600;">Shop</a>
  </div>

  <h1 class="page-title">All Projects (<%= @total_projects %>)</h1>

  <h2 style="margin: 20px 0 12px;">Pending Review (<%= @pending_projects.count %>)</h2>
  
  <% if @pending_projects.any? %>
    <div class="admin-table">
      <% @pending_projects.each do |project| %>
        <div class="admin-row card" data-project-id="<%= project.id %>">
          <div class="admin-row__main">
            <div class="admin-row__title"><%= project.name %></div>
            <div class="admin-row__meta muted">
              by <%= project.user.slack_username || project.user.email %> • 
              <%= project.hours %>h logged
              <% if project.submitted_at %>
                • submitted <%= time_ago_in_words(project.submitted_at) %> ago
              <% end %>
            </div>
            <% if project.description.present? %>
              <p class="admin-row__desc"><%= project.description %></p>
            <% end %>
            <div class="admin-row__links">
              <% if project.code_url.present? %>
                <a href="<%= project.code_url %>" target="_blank" class="btn btn--ghost" onclick="event.stopPropagation();">View Code</a>
              <% end %>
              <% if project.playable_url.present? %>
                <a href="<%= project.playable_url %>" target="_blank" class="btn btn--ghost" onclick="event.stopPropagation();">View Demo</a>
              <% end %>
              <a href="<%= admin_project_path(project) %>" class="btn btn--primary" onclick="event.stopPropagation();">Review Project</a>
            </div>
          </div>
          <div class="admin-row__actions" style="min-width: 280px;">
            <form class="approve-form" onsubmit="return false;" style="display: flex; flex-direction: column; gap: 8px;">
              <div>
                <label style="font-size: 12px; color: #666;">Approved Hours</label>
                <input type="number" class="approve-hours" value="<%= project.hours.to_f.round(2) %>" min="0" step="0.5" 
                       style="width: 100%; padding: 6px 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.9rem;">
              </div>
              <div>
                <label style="font-size: 12px; color: #666;">Hour Justification (internal)</label>
                <input type="text" class="approve-reason" placeholder="Why these hours..." 
                       style="width: 100%; padding: 6px 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.9rem;">
              </div>
              <div>
                <label style="font-size: 12px; color: #666;">User Reason (shown to user)</label>
                <input type="text" class="user-reason" placeholder="Feedback for the user..." 
                       style="width: 100%; padding: 6px 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 0.9rem;">
              </div>
              <div style="display: flex; gap: 4px;">
                <button type="button" class="btn btn--primary approve-btn" style="flex: 1; padding: 6px 12px;">Approve</button>
                <button type="button" class="btn btn--ghost reject-btn" style="flex: 1; padding: 6px 12px; color: #dc3545; border-color: #dc3545;">Reject</button>
              </div>
            </form>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="card" style="padding: 30px; text-align: center;">
      <p class="muted">No projects pending review.</p>
    </div>
  <% end %>

  <div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0 12px;">
    <h2 style="margin: 0;">All Projects (Page <%= @current_page %> of <%= @total_pages %>)</h2>
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <label for="status-filter" style="font-size: 14px; color: #666; font-weight: 600;">Filter:</label>
      <select id="status-filter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; cursor: pointer;" onchange="window.location.href = this.value">
        <option value="/admin/projects?page=1" <%= 'selected' if !@status_filter %>>All</option>
        <option value="/admin/projects?status=approved&page=1" <%= 'selected' if @status_filter == 'approved' %>>Approved</option>
        <option value="/admin/projects?status=in-review&page=1" <%= 'selected' if @status_filter == 'in-review' %>>In Review</option>
        <option value="/admin/projects?status=pending&page=1" <%= 'selected' if @status_filter == 'pending' %>>Pending</option>
        <option value="/admin/projects?status=rejected&page=1" <%= 'selected' if @status_filter == 'rejected' %>>Rejected</option>
      </select>
    </div>
  </div>
   
   <div class="admin-table">
    <% @projects.each do |project| %>
      <a href="<%= admin_project_path(project) %>" class="admin-row card" style="padding: 12px 16px; display: flex; justify-content: space-between; text-decoration: none; color: inherit;">
        <div class="admin-row__main">
          <strong><%= project.name %></strong>
          <span class="muted">by <%= project.user.slack_username || project.user.email %></span>
        </div>
        <div>
          <span class="pill pill--<%= project.status %>"><%= project.status.humanize %></span>
          <span class="muted"><%= project.hours %>h → <%= project.approved_hours || "—" %>h</span>
        </div>
      </a>
    <% end %>
  </div>

  <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 2rem;">
    <% if @current_page > 1 %>
      <a href="/admin/projects?page=<%= @current_page - 1 %>" class="btn btn--ghost">← Previous</a>
    <% end %>
    
    <span style="padding: 8px 16px; align-self: center;">Page <%= @current_page %> of <%= @total_pages %></span>
    
    <% if @current_page < @total_pages %>
      <a href="/admin/projects?page=<%= @current_page + 1 %>" class="btn btn--ghost">Next →</a>
    <% end %>
  </div>
</main>

<script>
  document.querySelectorAll('.approve-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const row = btn.closest('.admin-row');
      const projectId = row.dataset.projectId;
      const hours = parseFloat(row.querySelector('.approve-hours').value);
      const reason = row.querySelector('.approve-reason').value.trim();
      const userReason = row.querySelector('.user-reason').value.trim();

      if (!reason) {
        alert('Please provide an hour justification.');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Approving...';

      try {
        const response = await fetch(`/api/v1/admin/projects/${projectId}/approve`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
          },
          credentials: 'same-origin',
          body: JSON.stringify({ hours, reason, user_reason: userReason })
        });

        if (response.ok) {
          window.location.reload();
        } else {
          const data = await response.json();
          alert(data.error || 'Failed to approve project.');
        }
      } catch (error) {
        console.error('Failed to approve:', error);
        alert('Failed to approve project.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Approve';
      }
    });
  });

  document.querySelectorAll('.reject-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      
      const row = btn.closest('.admin-row');
      const userReason = row.querySelector('.user-reason').value.trim();

      if (!userReason) {
        alert('Please provide a user reason explaining why this is being rejected.');
        return;
      }

      if (!confirm('Are you sure you want to reject this project?')) return;

      const projectId = row.dataset.projectId;

      btn.disabled = true;
      btn.textContent = 'Rejecting...';

      try {
        const response = await fetch(`/api/v1/admin/projects/${projectId}/reject`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
          },
          credentials: 'same-origin',
          body: JSON.stringify({ user_reason: userReason })
        });

        if (response.ok) {
          window.location.reload();
        } else {
          const data = await response.json();
          alert(data.error || 'Failed to reject project.');
        }
      } catch (error) {
        console.error('Failed to reject:', error);
        alert('Failed to reject project.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Reject';
      }
    });
  });
</script>
