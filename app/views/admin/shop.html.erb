<% content_for :title, "Admin • Shop" %>
<% content_for :page, "admin" %>

<header class="topbar">
  <nav class="nav">
    <a class="nav__item" href="/projects">← Back to Projects</a>
    <a class="nav__item nav__item--active" href="/admin">Admin</a>
  </nav>
  <div class="topbar__right">
    <span class="muted">Admin: <%= @current_user.slack_username || @current_user.email %></span>
  </div>
</header>

<main class="container">
  <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 1rem;">
    <a href="/admin/projects" style="padding: 8px 16px; border-bottom: 2px solid transparent; color: #999; text-decoration: none; font-weight: 600;">Projects</a>
    <a href="/admin/users" style="padding: 8px 16px; border-bottom: 2px solid transparent; color: #999; text-decoration: none; font-weight: 600;">Users</a>
    <a href="/admin/shop" style="padding: 8px 16px; border-bottom: 2px solid #f25f2c; color: #f25f2c; text-decoration: none; font-weight: 600;">Shop</a>
  </div>

  <h1 class="page-title">Shop</h1>

  <div class="card" style="padding: 2rem; margin-bottom: 2rem; max-width: 600px;">
    <h2 style="margin-top: 0; margin-bottom: 1.5rem;">Add New Item</h2>
    
    <form id="add-item-form" style="display: flex; flex-direction: column; gap: 1rem;">
      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Item Name *</label>
        <input type="text" id="item_name" placeholder="e.g. Sticker Pack" style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem;" required>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Description</label>
        <textarea id="item_description" placeholder="Describe the item" rows="3" style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem; font-family: inherit;"></textarea>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Bolt Cost *</label>
          <input type="number" id="item_cost" min="0" placeholder="100" style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem;" required>
        </div>

        <div>
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Status *</label>
          <select id="item_status" style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem;" required>
            <option value="">Select status</option>
            <option value="active">Active</option>
            <option value="in stock">In Stock</option>
            <option value="out of stock">Out of Stock</option>
            <option value="hidden">Hidden</option>
          </select>
        </div>
      </div>

      <div>
        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Image URL</label>
        <input type="url" id="item_image_url" placeholder="https://example.com/image.jpg" style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem;">
      </div>

      <button type="submit" id="add-item-btn" class="btn btn--primary">Add Item</button>
    </form>
  </div>

  <h2 style="margin: 2rem 0 1rem;">Grant Items by Category</h2>

  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 2rem;">
    <% @shop_items.each do |category| %>
      <div>
        <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem; border-bottom: 2px solid #f25f2c; padding-bottom: 0.5rem;"><%= category[:name] %></h3>
        <div style="display: grid; gap: 0.75rem;">
          <% category[:variants].each do |variant| %>
            <div style="background: #f9f9f9; padding: 1rem; border-radius: 6px; border-left: 4px solid #f25f2c;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                <span style="font-weight: 600;"><%= variant[:label] %></span>
                <span style="background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600;"><%= variant[:bolts] %> bolts</span>
              </div>
              <div style="color: #666; font-size: 0.9rem;">
                Grants <strong style="color: #f25f2c;">$<%= variant[:grant] %> HCB</strong>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

    <h2 style="margin: 3rem 0 1rem;">Recent Orders (<%= @shop_orders.count %>)</h2>

    <div class="card" style="overflow: hidden;">
    <table style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr style="background: #f5f5f5; border-bottom: 1px solid #e0e0e0;">
        <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem;">User</th>
        <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem;">Order Name</th>
        <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem;">Status</th>
        <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.9rem;">Date</th>
      </tr>
    </thead>
    <tbody>
      <% if @shop_orders.empty? %>
        <tr>
          <td colspan="4" style="padding: 2rem; text-align: center; color: #999;">No orders yet</td>
        </tr>
      <% else %>
        <% @shop_orders.each do |order| %>
          <tr style="border-bottom: 1px solid #e0e0e0;">
            <td style="padding: 1rem;">
              <span style="font-weight: 600;"><%= order.user.first_name %> <%= order.user.last_name %></span>
              <br>
              <span class="muted" style="font-size: 0.9rem;"><%= order.user.email %></span>
            </td>
            <td style="padding: 1rem;">
              <%= order.name %>
            </td>
            <td style="padding: 1rem;">
              <select class="order-status" data-order-id="<%= order.id %>" style="padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; border: 1px solid #ddd;">
                <option value="pending" <%= 'selected' if order.status == 'pending' %>>Pending</option>
                <option value="completed" <%= 'selected' if order.status == 'completed' %>>Completed</option>
                <option value="cancelled" <%= 'selected' if order.status == 'cancelled' %>>Cancelled</option>
              </select>
            </td>
            <td style="padding: 1rem; color: #999; font-size: 0.9rem;">
              <%= order.created_at.strftime('%b %d, %Y') %>
            </td>
          </tr>
        <% end %>
      <% end %>
    </tbody>
    </table>
    </div>
    </main>

    <script>
      const addItemForm = document.getElementById('add-item-form');
      const addItemBtn = document.getElementById('add-item-btn');

      addItemForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        addItemBtn.disabled = true;
        addItemBtn.textContent = 'Adding...';

        const data = {
          shop_item: {
            name: document.getElementById('item_name').value,
            description: document.getElementById('item_description').value,
            cost: parseFloat(document.getElementById('item_cost').value),
            status: document.getElementById('item_status').value,
            image_url: document.getElementById('item_image_url').value
          }
        };

        try {
          const response = await fetch('/api/v1/admin/shop_items', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
          });

          if (response.ok) {
            window.location.reload();
          } else {
            const result = await response.json();
            alert(result.errors?.join(', ') || 'Failed to create item.');
          }
        } catch (error) {
          console.error('Failed to create shop item:', error);
          alert('Failed to create item. Please try again.');
        } finally {
          addItemBtn.disabled = false;
          addItemBtn.textContent = 'Add Item';
        }
      });

      document.querySelectorAll('.order-status').forEach(select => {
        select.addEventListener('change', async (e) => {
          const orderId = select.dataset.orderId;
          const newStatus = select.value;

          try {
            const response = await fetch(`/api/v1/admin/shop_orders/${orderId}`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content
              },
              credentials: 'include',
              body: JSON.stringify({ order: { status: newStatus } })
            });

            if (response.ok) {
              const result = await response.json();
              alert('Order status updated!');
              window.location.reload();
            } else {
              console.error('Response status:', response.status);
              const result = await response.json();
              console.error('Update failed:', result);
              alert(result.error || result.errors?.join(', ') || 'Failed to update order status.');
            }
          } catch (error) {
            console.error('Failed to update order status:', error);
            alert('Failed to update order. Error: ' + error.message);
          }
        });
      });
    </script>
